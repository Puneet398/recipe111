<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Admin Dashboard</title>

Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --primary-bg: #fff8f0;
  --accent: #ff7043;
  --accent-dark: #e64a19;
  --text-dark: #2c3e50;
  --text-light: #666;
  --card-bg: #ffffff;
  --sidebar-bg: #3e2723;
  --sidebar-hover: #ffab91;
}

* {
  box-sizing: border-box;
}

body {
  background-color: #1e1e1e;
  color: #f5f5f5;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

canvas {
  max-width: 100%;
  height: 300px;
}

/* Sidebar */
.sidebar {
  width: 220px;
  background-color: #2c2c2c;
  color: #fff;
  padding: 20px;
  display: flex;
  flex-direction: column;
  position: fixed;
  height: 100vh;
  top: 0;
  left: 0;
}

.sidebar h2 {
  font-size: 22px;
  margin-bottom: 30px;
  text-align: center;
}

.sidebar a {
  color: #f5f5f5;
  text-decoration: none;
  margin: 12px 0;
  font-weight: 500;
  padding: 8px 12px;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.sidebar a:hover {
  background-color: var(--accent);
}

.sidebar a.active {
  background-color: var(--accent);
  font-weight: bold;
}

/* Main Content */
.main {
  margin-left: 220px;
  padding: 40px 20px;
  flex: 1;
  overflow-y: auto;
}

.header h1 {
  font-size: 28px;
  color: var(--text-dark);
  margin-bottom: 6px;
}

.header p {
  color: var(--text-light);
  margin-bottom: 20px;
}

/* Card */
.card {
  background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  margin-bottom: 30px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  animation: fadeIn 0.6s ease-in-out;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
}

.card h3 {
  margin-top: 0;
  font-size: 20px;
  margin-bottom: 12px;
  color: #ffffff;
}

.card p,
.card ul,
.card li {
  font-size: 17px;
  line-height: 1.6;
  color: #f0f0f0;
}

.card ul {
  padding-left: 20px;
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 15px;
}

th,
td {
  padding: 12px;
  text-align: center;
}

.card table {
  margin-top: 0;
}

.card table th,
.card table td {
  font-size: 16px;
  color: #ffffff;
  border-bottom: 1px solid #333;
}

.card table thead {
  background-color: #2c2c2c;
}

.card table tbody tr:hover {
  background-color: #333;
}

/* Select Dropdown */
select {
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background-color: #fff;
}

/* Recipe List */
.recipe-list {
  list-style: none;
  padding: 0;
}

.recipe-item {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: space-between;
  padding: 15px;
  margin-bottom: 10px;
  background-color: #333;
  border-radius: 8px;
  border-left: 5px solid var(--accent);
  transition: background-color 0.2s, transform 0.1s;
  cursor: pointer;
}

.recipe-item:hover {
  background-color: #3a3a3a;
  transform: scale(1.01);
}

.recipe-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.recipe-content-toggle {
  width: 100%;
  margin-top: 10px;
  padding: 15px;
  background-color: #111;
  border-radius: 8px;
  color: #f5f5f5;
}

.recipe-content-toggle p,
.recipe-content-toggle li {
  color: #f5f5f5;
}

/* Animation */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar {
    position: relative;
    width: 100%;
    height: auto;
    flex-direction: row;
    justify-content: space-around;
  }

  .main {
    margin-left: 0;
    padding: 20px;
  }

  .sidebar a {
    margin: 0;
    font-size: 14px;
  }

  .card {
    padding: 16px;
  }

  .header h1 {
    font-size: 22px;
  }

  table,
  th,
  td {
    font-size: 13px;
  }
}
</style>
</head>
<body>
Â  <div class="sidebar">
Â  Â  <h2>Admin Panel</h2>
Â  Â  <a href="#" data-target="overview"><i class="fas fa-chart-pie"></i> Dashboard</a>
Â  Â  <a href="#" data-target="usage"><i class="fas fa-chart-line"></i> Usage Analytics</a>
Â  Â  <a href="#" data-target="recipes"><i class="fas fa-utensils"></i> All Recipes</a>
Â  Â  <a href="#" data-target="users"><i class="fas fa-users"></i> Users</a>
Â  Â  <a href="/" id="home"><i class="fas fa-home"></i> Home</a>
Â  Â  <a href="/auth/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>

Â  </div>

Â  <div class="main">
<div class="main">
Â  Â  <div class="header">
Â  Â  Â  Â  <h1>Welcome, {{ username }} ğŸ‘‹</h1> 
Â  Â  Â  Â  <p>You're logged in as <strong>{{ username }}</strong>.</p> 
Â  Â  </div>

Â  Â  <div class="card" id="overview">
Â  Â  Â  <h3>ğŸ“Š Dashboard Overview</h3>
Â  Â  Â  <div id="overviewContent">Loading...</div>
Â  Â  </div>

Â  Â  <div class="card" id="usage">
Â  Â  Â  <h3>ğŸ“ˆ Usage Analytics</h3>
Â  Â  Â  <div id="usageContent">Loading...</div>
Â  Â  </div>
Â  Â  <!-- <canvas id="usageChart" style="max-width: 100%; height: 300px;"></canvas> -->

<div class="card" id="recipes">
Â  Â  <h3>ğŸ½ï¸ All Recipes (Admin View)</h3>
Â  Â  <div id="recipeList">
Â  Â  Â  {% if recipes %}
Â  Â  Â  <ul class="recipe-list">
Â  Â  Â  Â  {% for r in recipes %}
Â  Â  Â  Â  <li class="recipe-item" data-filename="{{ r.filename }}" data-user-id="{{ r.user_id }}">
Â  Â  Â  Â  Â  <div class="recipe-item-header">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <strong class="recipe-title" style="color: #ff7043;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-book-open" style="margin-right: 5px;"></i> {{ r.name or 'Unknown Recipe' }} 
Â  Â  Â  Â  Â  Â  Â  </strong>
              {% set owner = users | selectattr('id', 'equalto', r.user_id | int) | first %}
Â  Â  Â  Â  Â  Â  Â  <small style="color: #aaa; display: block;">Owner: {{owner.username or 'N/A' }} | Added on {{ r.created | truncate(length=10, killwords=True, end='') }}</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <i class="fas fa-chevron-right" style="color: var(--accent);"></i>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  <div class="recipe-content-toggle" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  <p>Loading recipe content...</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </li>
Â  Â  Â  Â  {% endfor %}
Â  Â  Â  </ul>
Â  Â  Â  {% else %}
Â  Â  Â  <p>No recipes found across all users.</p>
Â  Â  Â  {% endif %}
Â  Â  </div>
</div>

Â  Â  <div class="card" id="users">
Â  Â  Â  <h3>ğŸ‘¥ User Activity</h3>
Â  Â  Â  <table style="width: 100%; border-collapse: collapse; margin-top: 0;">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th style="padding: 12px;">Username</th>
Â  Â  Â  Â  Â  Â  <th style="padding: 12px;">Recipes Added</th>
Â  Â  Â  Â  Â  Â  <th style="padding: 12px;">Role</th>
Â  Â  Â  Â  Â  Â  <!-- <th style="padding: 12px;">Actions</th> -->
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody id="userTableBody">
Â  Â  Â  Â  Â  <tr><td colspan="4" style="padding: 12px;">Loading...</td></tr>
Â  Â  Â  Â  </tbody>
Â  Â  Â  </table>
Â  Â  </div>


Â  </div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
Â  Â  const links = document.querySelectorAll('.sidebar a[data-target]');
Â  Â  const sections = document.querySelectorAll('.main .card');

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  loadDashboardMetrics();
Â  Â  Â  loadUsageAnalytics();
Â  Â  Â  // loadRecipeList() is removed because the recipe list is rendered by Flask (Jinja)
Â  Â  Â  loadUserTable();
Â  Â  Â  
Â  Â  Â  // --- Recipe Click Handler ---
Â  Â  Â  const recipeListElement = document.querySelector('.recipe-list');
Â  Â  Â  if (recipeListElement) {
Â  Â  Â  Â  Â  recipeListElement.addEventListener('click', function(e) {
Â  Â  Â  Â  Â  Â  Â  const item = e.target.closest('.recipe-item');
Â  Â  Â  Â  Â  Â  Â  // Ensure the click targets the entire item or its non-interactive children
Â  Â  Â  Â  Â  Â  Â  if (item && !e.target.closest('select')) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleRecipeContent(item);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  // ----------------------------
Â  Â  });

Â  Â  links.forEach(link => {
Â  Â  Â  link.addEventListener('click', function(e) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const targetId = this.getAttribute('data-target');
Â  Â  Â  Â  links.forEach(l => l.classList.remove('active'));
Â  Â  Â  Â  this.classList.add('active');
Â  Â  Â  Â  sections.forEach(section => {
Â  Â  Â  Â  Â  section.style.display = section.id === targetId ? 'block' : 'none';
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  });

Â  Â  sections.forEach(section => {
Â  Â  Â  section.style.display = section.id === 'overview' ? 'block' : 'none';
Â  Â  });

Â  Â  document.querySelector('.sidebar a[data-target="overview"]').classList.add('active');

Â  Â  // --- Core Functions ---
Â  Â  
Â  Â  async function loadDashboardMetrics() {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch('/api/dashboard-metrics');
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  document.getElementById('overviewContent').innerHTML = `
Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  <li>Total Recipes: ${data.total_recipes}</li>
Â  Â  Â  Â  Â  Â  <li>Active Users: ${data.active_users}</li>
Â  Â  Â  Â  Â  Â  <li>Last Sync: ${data.last_sync_time}</li>
Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  `;
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  document.getElementById('overviewContent').innerText = 'Failed to load metrics.';
Â  Â  Â  }
Â  Â  }

Â  Â  async function loadUsageAnalytics() {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch('/api/usage-analytics');
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  document.getElementById('usageContent').innerHTML = `
Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  <li>Most Scraped Source: ${data.top_source}</li>
Â  Â  Â  Â  Â  Â  <li>Popular Folder Tags: ${data.popular_tags.join(', ')}</li>
Â  Â  Â  Â  Â  Â  <li>Average Recipes per User: ${data.avg_recipes}</li>
Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  `;
Â  Â  Â  Â  // renderUsageChart(data);
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  document.getElementById('usageContent').innerText = 'Failed to load analytics.';
Â  Â  Â  }
Â  Â  }

Â  Â  function renderUsageChart(data) {
Â  Â  Â  const ctx = document.getElementById('usageChart').getContext('2d');
Â  Â  Â  new Chart(ctx, {
Â  Â  Â  Â  type: 'doughnut',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  labels: ['Scraped Recipes', 'Manual Recipes', 'Favorites'],
Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  data: [data.scraped_count || 40, data.manual_count || 20, data.favorites_count || 10],
Â  Â  Â  Â  Â  Â  backgroundColor: ['#ff7043', '#ffa726', '#66bb6a'],
Â  Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  legend: { position: 'bottom' },
Â  Â  Â  Â  Â  Â  tooltip: { enabled: true }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // --- Function to toggle and fetch recipe content ---
Â  Â  async function toggleRecipeContent(recipeItem) {
Â  Â  Â  Â  const filename = recipeItem.getAttribute('data-filename');
Â  Â  Â  Â  const userId = recipeItem.getAttribute('data-user-id');
Â  Â  Â  Â  const contentDiv = recipeItem.querySelector('.recipe-content-toggle');
Â  Â  Â  Â  const arrowIcon = recipeItem.querySelector('.fas.fa-chevron-right');

Â  Â  Â  Â  if (contentDiv.style.display === 'block') {
Â  Â  Â  Â  Â  Â  // Hide content if already visible (collapse feature)
Â  Â  Â  Â  Â  Â  contentDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  arrowIcon.style.transform = 'rotate(0deg)';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Show content area and loading message
Â  Â  Â  Â  contentDiv.style.display = 'block';
Â  Â  Â  Â  contentDiv.innerHTML = '<p style="color: var(--accent);">â³ Loading recipe content...</p>';
Â  Â  Â  Â  arrowIcon.style.transform = 'rotate(90deg)';

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Fetch content, passing the userId as a query parameter for admin cross-user access
Â  Â  Â  Â  Â  Â  // Note: The backend expects 'owner_id' for shared access, but the dashboard uses 'user_id' in data attributes.
Â  Â  Â  Â  Â  Â  const res = await fetch(`/api/recipe/${filename}?owner_id=${userId}`);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  if (res.status === 401 || res.status === 403) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Unauthorized access to this recipe.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`HTTP error! Status: ${res.status}`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  const markdownContent = data.content || "Recipe content is empty.";

Â  Â  Â  Â  Â  Â  // Convert Markdown content to HTML using marked.parse()
Â  Â  Â  Â  Â  Â  const htmlContent = marked.parse(markdownContent); 

Â  Â  Â  Â  Â  Â  // Update the content div with the rendered HTML
Â  Â  Â  Â  Â  Â  contentDiv.innerHTML = htmlContent;

Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error('Error fetching recipe content:', err);
Â  Â  Â  Â  Â  Â  contentDiv.innerHTML = `<p style="color: salmon;">âŒ Failed to load recipe: ${err.message}</p>`;
Â  Â  Â  Â  }
Â  Â  }
// ---------------------------------------------------------------------


async function loadUserTable() {
Â  Â  try {
Â  Â  Â  Â  const res = await fetch('/api/users'); // Fetches user data
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${res.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  const users = await res.json();
Â  Â  Â  Â  const tbody = document.getElementById('userTableBody');
Â  Â  Â  Â  
Â  Â  Â  Â  tbody.innerHTML = users.map(u => `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 14px;">${u.username}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 14px;">${u.recipe_count}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 14px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="role-${u.id}" onchange="updateUserRole(${u.id}, this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="family" ${u.role === 'family' ? 'selected' : ''}>Family</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="user" ${u.role === 'user' ? 'selected' : ''}>User</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="status-${u.id}" style="margin-left: 10px; font-size: 12px;"></span> </td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `).join('');
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Failed to load users:', err); // Log the error
Â  Â  Â  Â  document.getElementById('userTableBody').innerHTML = `<tr><td colspan="3" style="padding: 14px;">Failed to load users. Check console for details.</td></tr>`;
Â  Â  }
}

async function updateUserRole(userId, newRole) {
Â  Â  Â const statusEl = document.getElementById(`status-${userId}`); // Get the status span
Â  Â  Â statusEl.textContent = 'â³ Saving...'; // Show saving message
Â  Â  Â statusEl.style.color = '#aaa'; // Default color
Â  Â  Â try {
Â  Â  Â  Â const res = await fetch('/api/update-role', {
Â  Â  Â  Â  Â method: 'POST',
Â  Â  Â  Â  Â headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â body: JSON.stringify({ user_id: userId, new_role: newRole })
Â  Â  Â  Â });

Â  Â  Â  Â const result = await res.json();
Â  Â  Â  Â 
Â  Â  Â  Â if (res.ok) {
Â  Â  Â  Â  Â statusEl.textContent = 'âœ… Updated';
Â  Â  Â  Â  Â statusEl.style.color = 'lightgreen';
Â  Â  Â  Â } else {
Â  Â  Â  Â  Â statusEl.textContent = `âŒ Failed: ${result.error || 'Unknown error'}`;
Â  Â  Â  Â  Â statusEl.style.color = 'salmon';
Â  Â  Â  Â }
Â  Â  Â  Â // Clear the status message after a few seconds
Â  Â  Â  Â setTimeout(() => { statusEl.textContent = ''; }, 3000); 

Â  Â  Â } catch (err) {
Â  Â  Â  Â console.error('Error updating role:', err); // Log the error
Â  Â  Â  Â statusEl.textContent = 'âŒ Error';
Â  Â  Â  Â statusEl.style.color = 'salmon';
Â  Â  Â  Â setTimeout(() => { statusEl.textContent = ''; }, 3000);
Â  Â  Â }
Â  Â }
Â  </script>
</body>
</html>
